<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="×©×¢×•×Ÿ × ×•×›×—×•×ª">
  <title>×©×¢×•×Ÿ × ×•×›×—×•×ª</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #1a1a2e;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { font-size: 1.3em; margin: 20px 0 4px; color: #a0c4ff; }
    #clock { font-size: 3em; font-weight: bold; margin: 10px 0; letter-spacing: 3px; }
    #date-display { font-size: 0.9em; color: #aaa; margin-bottom: 20px; }
    .btn {
      width: 100%; max-width: 340px;
      padding: 20px; font-size: 1.2em; font-weight: bold;
      border: none; border-radius: 14px; cursor: pointer;
      margin: 8px 0; transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.4; }
    #btn-in   { background: #27ae60; color: white; }
    #btn-out  { background: #e74c3c; color: white; }
    #btn-sub  { background: #2980b9; color: white; margin-top: 16px; }
    #btn-view { background: #555; color: white; font-size: 0.9em; padding: 12px; }
    #status {
      margin: 12px 0; padding: 12px 16px; border-radius: 10px;
      font-size: 0.95em; text-align: center;
      max-width: 340px; width: 100%; display: none;
    }
    #status.ok  { background:#1e3a2e; border:1px solid #27ae60; color:#27ae60; }
    #status.err { background:#3a1e1e; border:1px solid #e74c3c; color:#e74c3c; }
    #status.info{ background:#1e2a3a; border:1px solid #2980b9; color:#7fb3d3; }
    #records-panel {
      width: 100%; max-width: 340px;
      background: #252540; border-radius: 12px;
      margin-top: 14px; overflow: hidden; display: none;
    }
    #records-panel h3 { padding: 10px 14px; background: #333; font-size: 0.95em; }
    .rec-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 14px; border-bottom: 1px solid #333; font-size: 0.88em;
    }
    .rec-row .date { color: #aaa; }
    .rec-row .times { color: white; }
    .rec-row .del { color: #e74c3c; cursor: pointer; padding: 2px 6px; }
    .rec-row.submitted { opacity: 0.5; }
    #config-link { margin-top: 16px; font-size: 0.78em; color: #555; }
    #config-link a { color: #a0c4ff; }
    .badge {
      display: inline-block; background: #e74c3c;
      color: white; border-radius: 10px; font-size: 0.7em;
      padding: 2px 7px; margin-right: 6px; vertical-align: middle;
    }
  </style>
</head>
<body>
<h1>â± ×©×¢×•×Ÿ × ×•×›×—×•×ª</h1>
<div id="clock">--:--:--</div>
<div id="date-display"></div>

<button class="btn" id="btn-in"  onclick="punch('IN')">ğŸŸ¢ ×›× ×™×¡×”</button>
<button class="btn" id="btn-out" onclick="punch('OUT')">ğŸ”´ ×™×¦×™××”</button>
<div id="status"></div>

<button class="btn" id="btn-sub" onclick="submitAll()">
  ğŸ“¤ ×©×œ×— ×œ-Isufit <span id="pending-badge" class="badge" style="display:none">0</span>
</button>
<button class="btn" id="btn-view" onclick="toggleRecords()">ğŸ“‹ ×”×¦×’ ×¨×©×•××•×ª ×©××•×¨×•×ª</button>

<div id="records-panel">
  <h3>×¨×©×•××•×ª ×©××•×¨×•×ª</h3>
  <div id="records-list"></div>
</div>

<div id="config-link">
  ×¢×•×‘×“: <strong id="display-worker"></strong> |
  <a href="#" onclick="showConfig()">×”×’×“×¨×•×ª</a>
</div>

<script>
const ISUFIT = 'https://extisufit.ngsoft.com/isufit';
let workerCode = localStorage.getItem('isufit_worker') || '4282';
document.getElementById('display-worker').textContent = workerCode;

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick() {
  const n = new Date();
  const pad = x => String(x).padStart(2,'0');
  document.getElementById('clock').textContent =
    `${pad(n.getHours())}:${pad(n.getMinutes())}:${pad(n.getSeconds())}`;
  const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
  const months = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™',
                  '×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  document.getElementById('date-display').textContent =
    `×™×•× ${days[n.getDay()]}, ${n.getDate()} ${months[n.getMonth()]} ${n.getFullYear()}`;
}
setInterval(tick, 1000); tick();

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayKey() {
  const n = new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${n.getDate()}`;
}
function nowHHMM() {
  const n = new Date();
  return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}
function getAllRecords() {
  return JSON.parse(localStorage.getItem('isufit_records') || '{}');
}
function saveAllRecords(obj) {
  localStorage.setItem('isufit_records', JSON.stringify(obj));
  updateBadge();
}

// â”€â”€ Punch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function punch(type) {
  const key   = todayKey();
  const time  = nowHHMM();
  const recs  = getAllRecords();
  if (!recs[key]) recs[key] = { in: '', out: '', submitted: false };
  if (type === 'IN') {
    recs[key].in = time;
    showStatus(`âœ… ×›× ×™×¡×” × ×©××¨×”: ${time}`, 'ok');
  } else {
    recs[key].out = time;
    showStatus(`âœ… ×™×¦×™××” × ×©××¨×”: ${time}`, 'ok');
  }
  saveAllRecords(recs);
  renderRecords();
}

// â”€â”€ Submit all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitAll() {
  const recs = getAllRecords();
  const pending = Object.entries(recs).filter(([,v]) => !v.submitted && (v.in || v.out));
  if (pending.length === 0) {
    showStatus('××™×Ÿ ×¨×©×•××•×ª ×—×“×©×•×ª ×œ×©×œ×™×—×”', 'info');
    return;
  }
  showStatus(`â³ ×©×•×œ×— ${pending.length} ×™××™×...`, 'info');
  document.getElementById('btn-sub').disabled = true;
  let ok = 0, fail = 0;
  for (const [date, rec] of pending) {
    if (rec.in) {
      const success = await sendRecord(date, 'IN122', rec.in);
      if (success) ok++; else fail++;
    }
    if (rec.out) {
      const success = await sendRecord(date, 'OUT122', rec.out);
      if (success) ok++; else fail++;
    }
    if (fail === 0) {
      recs[date].submitted = true;
    }
    await sleep(200);
  }
  saveAllRecords(recs);
  renderRecords();
  document.getElementById('btn-sub').disabled = false;
  if (fail === 0) {
    showStatus(`âœ… × ×©×œ×—×• ${ok} ×¨×©×•××•×ª ×‘×”×¦×œ×—×”!`, 'ok');
  } else {
    showStatus(`âš ï¸ ${ok} ×”×¦×œ×™×—×•, ${fail} × ×›×©×œ×•. ×”×× ××ª×” ××—×•×‘×¨ ×œ-Isufit?`, 'err');
    openIsufitLogin();
  }
}

async function sendRecord(date, tbName, value) {
  const url = `${ISUFIT}/ops/opSaveTBChange.aspx` +
    `?workerCode=${workerCode}&forDate=${date}&tbName=${tbName}` +
    `&newVal=${encodeURIComponent(value)}&caller=main`;
  try {
    const resp = await fetch(url, { credentials: 'include' });
    return resp.ok;
  } catch (e) {
    return false;
  }
}

function openIsufitLogin() {
  showStatus('ğŸ” ××ª×—×‘×¨ ×œ-Isufit... ××—×¨×™ ×”×”×ª×—×‘×¨×•×ª ×—×–×•×¨ ×•×¡×™×™× ×©×•×‘ "×©×œ×—"', 'info');
  window.open(`${ISUFIT}/login.aspx`, '_blank');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showStatus(msg, type) {
  const el = document.getElementById('status');
  el.textContent = msg; el.className = type; el.style.display = 'block';
  if (type !== 'err') setTimeout(() => el.style.display = 'none', 5000);
}

function updateBadge() {
  const recs = getAllRecords();
  const count = Object.values(recs).filter(v => !v.submitted && (v.in || v.out)).length;
  const badge = document.getElementById('pending-badge');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline-block' : 'none';
}

function toggleRecords() {
  const panel = document.getElementById('records-panel');
  panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  renderRecords();
}

function renderRecords() {
  const recs = getAllRecords();
  const list = document.getElementById('records-list');
  list.innerHTML = '';
  const sorted = Object.keys(recs).sort().reverse();
  if (sorted.length === 0) {
    list.innerHTML = '<div class="rec-row" style="color:#666">××™×Ÿ ×¨×©×•××•×ª</div>';
    return;
  }
  for (const date of sorted) {
    const r = recs[date];
    const row = document.createElement('div');
    row.className = 'rec-row' + (r.submitted ? ' submitted' : '');
    row.innerHTML = `
      <span class="date">${date} ${r.submitted ? 'âœ“' : ''}</span>
      <span class="times">ğŸŸ¢ ${r.in||'--'} &nbsp; ğŸ”´ ${r.out||'--'}</span>
      <span class="del" onclick="deleteRecord('${date}')">âœ•</span>`;
    list.appendChild(row);
  }
}

function deleteRecord(date) {
  if (!confirm(`××—×§ ×¨×©×•××” ×œ×ª××¨×™×š ${date}?`)) return;
  const recs = getAllRecords();
  delete recs[date];
  saveAllRecords(recs);
  renderRecords();
}

function showConfig() {
  const code = prompt('×§×•×“ ×¢×•×‘×“ (Worker Code):', workerCode);
  if (code && code.trim()) {
    workerCode = code.trim();
    localStorage.setItem('isufit_worker', workerCode);
    document.getElementById('display-worker').textContent = workerCode;
    showStatus('âœ… ×§×•×“ ×¢×•×‘×“ ×¢×•×“×›×Ÿ', 'ok');
  }
}

// Init
updateBadge();
</script>
</body>
</html>
